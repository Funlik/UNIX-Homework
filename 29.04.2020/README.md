# Домашнее задание на 29.04.2020

## Задание
Поднимите самбу(samba). Поднимите любой веб-сервер(nginx, apache, lighttpd, cherokee). пошарьте папку со страницами(или переназначьте веб сервер на пошаренную папку). Сделайте так чтобы вы могли коммитить в эту-же папку гитом.
Делайте бекап кода веб страниц в 05-00 каждый день, если день не дождливый. 
Учитывайте что бекап кода может быть поврежден если в момент бекапа кто-то пишет по самбе.

 

От вас я хочу док-файл с картинками и описанием что и в какой последовательности вы делали.

## Решение
Я использовал Docker, потому что ~~мне было лень устанавливать вирутальную машину~~ так легче всего наглядно продемонстрировать работу моей конфигурации

### Запуск
Чтобы собрать и запустить контейнер с моим решением достаточно выполнить следующие команды:
```shell
docker build --tag unixhw:1.0 .
docker run --mount src="$(pwd)/data",target=/files,type=bind -p 8080:80 -p 445:445 unixhw:1.0
# на 80 порте моей основной машинки живет http-сервер для моих личных нужд, 
# поэтому 80 порт контейнера я пробросил на 8080. Если хотите на 80 — просто измените 8080 на 80.
```
### Как это работает
В Docker-контейнерах нет systemd или другой полноценно работающей системы инициализации, поэтому сервисы при старте контейнера приходится запускать вручную. За это отвечает файл [init.sh](29.04.2020/configs/init.sh), содержащий в себе команды для старта cron, HTTP и SMB серверов.

[Dockerfile](29.04.2020/Dockerfile) содержит скрипт, который при создании образа копирует директорию configs внутрь образа, устанавливает Samba и Git, перемещает конфигруационные файлы в соответствующие директории.
При запуске же стартует скрипт [init.sh](29.04.2020/configs/init.sh).

Далее я излагаю пошаговую настройку:

### 1. Установка Samba
Samba в дистрибутивы с пакетным менеджером apt обычно можно установить из репозиториев следующим образом:
```shell
apt-get update && apt-get install -y samba
```
Далее я создал довольно простой [конфигурационный файл](29.04.2020/configs/smb.conf), в котором, по большому счету, нечего и прокомментировать.
Можно заметить, что я реализовал вход гостей на samba-шару под root:
```
force user = root
```
На основной системе это было бы несколько несекьюрно, и лучше было бы настроить права на запись в директорию для определенной группы, но в моем случае подобное не играет роли, т.к. я работаю с контейнером.
Конфигурационный файл я поместил в `/etc/samba/smb.conf`

### 2. Веб-сервер

Мой веб-сервер не требует установки, запускается одной командой и использует `python3`, входящий в состав многих дистрибутивов:
```shell
python3 -m http.server 80 --directory /files
```

### 3. Git
Чтобы коммитить в папку Git'ом, достаточно просто инициализировать в ней репозиторий. Я добавил инициализацию репозитория в скрипт, выполнящийся при старте контейнера, а также сделал проверку на случай, если репозиторий уже инициализирован:
```shell
if ! [ -d /files/.git ]; then
	git init /files/
fi
```

### 4. Бекап
Чтобы делать бекап кода веб страниц в 05:00 каждый день, если день не дождливый, я написал [специальный скрипт](29.04.2020/configs/backup.sh).

Скрипт использует сайт wttr.in для сверки погоды и tar для создания бекапов. Бекапы именуются с учетом текущей даты.

Чтобы избежать проблем с перезаписью файлов во время бекапа, я отправляю SIGTSTP процессу сервера Samba, что приостанавливает его, предотвращая запись. После выполнения бекапа я отправляю процессу SIGCONT, что, соответственно, возобновляет его работу.

Далее этот скрипт был [добавлен в cron](29.04.2020/configs/crontab):
```
0 5 * * * sh /usr/configs/backup.sh
```

### Картинки
Честно говоря, не знаю, что здесь можно проиллюстрировать. Но раз нужны картинки, я приложу скриншоты, демонстрирующие работу серверов SAMBA и HTTP:

![Скриншот SMB-клиента](https://i.imgur.com/l8orPQJ.png "Скриншот SMB-клиента")
![Скриншот HTTP-клиента](https://i.imgur.com/KSOvWDl.png "Скриншот HTTP-клиента")
